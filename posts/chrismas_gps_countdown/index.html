<!DOCTYPE html>
<html lang="en-uk">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='Taking the christmas countdown I created last year and upgrading it using a GPS module'><title>Upgrading the christmas countdown with GPS</title>

<link rel='canonical' href='https://jjhorton.co.uk/posts/chrismas_gps_countdown/'>

<link rel="stylesheet" href="/scss/style.min.775dbd4fd34fda61c5273b4bc3415f7c9666414fb6c40aab164a7ded4397da98.css"><meta property='og:title' content='Upgrading the christmas countdown with GPS'>
<meta property='og:description' content='Taking the christmas countdown I created last year and upgrading it using a GPS module'>
<meta property='og:url' content='https://jjhorton.co.uk/posts/chrismas_gps_countdown/'>
<meta property='og:site_name' content='James Horton'>
<meta property='og:type' content='article'><meta property='article:section' content='Posts' /><meta property='article:tag' content='RP2040' /><meta property='article:tag' content='GPS' /><meta property='article:tag' content='PMod' /><meta property='article:tag' content='Raspberry Pi' /><meta property='article:published_time' content='2022-12-15T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2022-12-15T00:00:00&#43;00:00'/><meta property='og:image' content='https://jjhorton.co.uk/img/countdown_gps_running.png' />
<meta name="twitter:site" content="@JamesjHorton">
    <meta name="twitter:creator" content="@JamesjHorton"><meta name="twitter:title" content="Upgrading the christmas countdown with GPS">
<meta name="twitter:description" content="Taking the christmas countdown I created last year and upgrading it using a GPS module"><meta name="twitter:card" content="summary">
    <meta name="twitter:image" content='https://jjhorton.co.uk/img/countdown_gps_running.png' />
<script async src="https://www.googletagmanager.com/gtag/js?id=G-HS5DDLL3E1"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-HS5DDLL3E1', { 'anonymize_ip': false });
}
</script>

    </head>
    <body class="
    article-page 
">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex 
    
        on-phone--column extended
    
">
    
        <aside class="sidebar left-sidebar sticky">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header class="site-info">
        
            
            <figure class="site-avatar">
                
                    
                    
                    
                        
                        <img src="/img/myavatar_hu1a63ebca8992f7e52bef7b2eba41d0ac_58941_300x0_resize_box_3.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                

                
            </figure>
            
        
        
        <h1 class="site-name"><a href="/">James Horton</a></h1>
        <h2 class="site-description">A selection of posts about my random projects at home, covering topics from Electronics to Software Defined Radio, and anything else I can think of</h2><ol class="social-menu">
                
                    <li>
                        <a 
                            href='https://github.com/jjhorton'
                            target="_blank"
                            title="GitHub"
                        >
                            
                            
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                            
                        </a>
                    </li>
                
                    <li>
                        <a 
                            href='https://www.linkedin.com/in/jjhorton/'
                            target="_blank"
                            title="LinkedIn"
                        >
                            
                            
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-linkedin" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <rect x="4" y="4" width="16" height="16" rx="2" />
  <line x1="8" y1="11" x2="8" y2="16" />
  <line x1="8" y1="8" x2="8" y2="8.01" />
  <line x1="12" y1="16" x2="12" y2="11" />
  <path d="M16 16v-3a2 2 0 0 0 -4 0" />
</svg>
                            
                        </a>
                    </li>
                
                    <li>
                        <a 
                            href='https://twitter.com/JamesjHorton'
                            target="_blank"
                            title="Twitter"
                        >
                            
                            
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                            
                        </a>
                    </li>
                
            </ol></header>

    <ol class="menu" id="main-menu">
        
        
        

        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        

        <li >
            <a href='/pages/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About</span>
            </a>
        </li>
        
        

        <li >
            <a href='/posts/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archive</span>
            </a>
        </li>
        

        
            <li id="dark-mode-toggle">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                <span>Dark Mode</span>
            </li>
        
    </ol>
</aside>

    
<main class="main full-width">
    <article class="main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/posts/chrismas_gps_countdown/">
                
                    <img src="/img/countdown_gps_running.png" loading="lazy" alt="Featured image of post Upgrading the christmas countdown with GPS" />
                
            </a>
        </div>
    

    <div class="article-details">
    

    <h2 class="article-title">
        <a href="/posts/chrismas_gps_countdown/">Upgrading the christmas countdown with GPS</a>
    </h2>

    
    <h3 class="article-subtitle">
        Taking the christmas countdown I created last year and upgrading it using a GPS module
    </h3>
    

    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Dec 15, 2022</time>
            </div>
        

        
    </footer>
    
</div>
</header>

    <section class="article-content">
    <p>The countdown timer that I created last year, which used my custom <a class="link" href="https://jjhorton.co.uk/posts/rp2040_pmod/" >RP2040 Pmod board</a> with the <a class="link" href="https://jjhorton.co.uk/posts/sevensegmentdisp/" >PMod Severn Segment Display</a> I had also created, was in need of an upgrade. The main aim of this project was to replace the Raspberry Pi Zero that provided the time data to what was just a display made of my custom hardware, and turn it into something that can run automonously, by getting that time data from a <a class="link" href="https://jjhorton.co.uk/posts/gps_pmod_board/" >GPS reveiver</a>.</p>
<p>The main advantage of using GPS data for this is that by using a GPS receiver we have a high accuracy timing data source, now I wanted to understand how I can make the display update as accurate as possible using this new timing source so I needed to measure how well my initial setup worked, so I built a test setup.</p>
<p><figure 
	>
	<a href="/img/countdown_gps_testing.png" >
		<img src="/img/countdown_gps_testing.png"
			
			
			
			loading="lazy"
			alt="Tesing the GPS receiver with DSLogic Logic Analyiser">
	</a>
	
	<figcaption>Tesing the GPS receiver with DSLogic Logic Analyiser</figcaption>
	
</figure></p>
<p>With this test setup, using some PMod Breakout Boards, I could monitor the Serial Data and 1 PPS from the GPS, as well as the Clock and Data lines to the PMod 7 Segement display. By monitoring all these signals at the same time I could monitor the progress of the data through the system, the 1 Pulse Per Second (PPS) signal makes the absolute point that a second begins and the time at which the data is valid for, we can then reference the delay in which it takes from the time information to reach the display.</p>
<p><figure 
	>
	<a href="/img/countdown_gps_before.png" >
		<img src="/img/countdown_gps_before.png"
			
			
			
			loading="lazy"
			alt="Using Pulse Veiw to measure the data">
	</a>
	
	<figcaption>Using Pulse Veiw to measure the data</figcaption>
	
</figure></p>
<p>For the display, I assumed that once the data is completly sent, as the point at which it is displayed. There is a delay in the time it takes to be processed at the disaply, but it is small compared to the rest of the processing. For the measurements I am using <a class="link" href="https://sigrok.org/wiki/PulseView"  target="_blank" rel="noopener"
    >PulseVeiw</a> with my <a class="link" href="https://www.dreamsourcelab.com/product/dslogic-series/"  target="_blank" rel="noopener"
    >DS Logic Analyzer</a>, which allows me to see the the exact timeing of these signals, I can then try and summaries them using <a class="link" href="https://wavedrom.com/"  target="_blank" rel="noopener"
    >Wavedrom</a>, to show the <a class="link" href="https://wavedrom.com/editor.html?%7Bsignal%3A%20%5B%0A%20%20%7Bname%3A%20%27GPS%201pps%27%2C%20wave%3A%20%27l..hl.........hl.........%27%7D%2C%0A%20%20%7Bname%3A%20%27GPS%20Tx%27%2C%20wave%3A%20%27x...3..x.......4..x......%27%2C%20data%3A%20%5B%27GPS%28x%29%27%2C%20%27GPS%28x%2B1%29%27%5D%7D%2C%0A%20%20%7B%7D%2C%0A%20%20%7Bname%3A%20%27Time%27%2C%20wave%3A%20%27.x....3.x........4.x......%27%2C%20data%3A%20%5B%27T%28x%29%27%2C%27T%28x%2B1%29%27%5D%2C%20phase%3A%200.5%20%7D%2C%0A%20%20%7B%7D%2C%0A%20%20%7Bname%3A%20%27Display%27%2C%20wave%3A%20%27x.......3.x........4.x...%27%2C%20data%3A%20%5B%27D%28x%29%27%2C%27D%28x%2B1%29%27%20%5D%7D%0A%5D%2C%0A%20%20head%3A%7B%0A%20%20%20text%3A%27GPS%20data%20delays%20to%20update%20display%27%7D%0A%7D%0A"  target="_blank" rel="noopener"
    >communication exchanges</a> rather than signals.</p>
<p><figure 
	>
	<a href="https://svg.wavedrom.com/%7Bsignal%3A%20%5B%0A%20%20%7Bname%3A%20%27GPS%201pps%27%2C%20wave%3A%20%27l..hl.........hl.........%27%7D%2C%0A%20%20%7Bname%3A%20%27GPS%20Tx%27%2C%20wave%3A%20%27x...3..x.......4..x......%27%2C%20data%3A%20%5B%27GPS%28x%29%27%2C%20%27GPS%28x%2B1%29%27%5D%7D%2C%0A%20%20%7B%7D%2C%0A%20%20%7Bname%3A%20%27Time%27%2C%20wave%3A%20%27.x....3.x........4.x......%27%2C%20data%3A%20%5B%27T%28x%29%27%2C%27T%28x%2B1%29%27%5D%2C%20phase%3A%200.5%20%7D%2C%0A%20%20%7B%7D%2C%0A%20%20%7Bname%3A%20%27Display%27%2C%20wave%3A%20%27x.......3.x........4.x...%27%2C%20data%3A%20%5B%27D%28x%29%27%2C%27D%28x%2B1%29%27%20%5D%7D%0A%5D%2C%0A%20%20head%3A%7B%0A%20%20%20text%3A%27GPS%20data%20delays%20to%20update%20display%27%7D%0A%7D%0A" >
		<img src="https://svg.wavedrom.com/%7Bsignal%3A%20%5B%0A%20%20%7Bname%3A%20%27GPS%201pps%27%2C%20wave%3A%20%27l..hl.........hl.........%27%7D%2C%0A%20%20%7Bname%3A%20%27GPS%20Tx%27%2C%20wave%3A%20%27x...3..x.......4..x......%27%2C%20data%3A%20%5B%27GPS%28x%29%27%2C%20%27GPS%28x%2B1%29%27%5D%7D%2C%0A%20%20%7B%7D%2C%0A%20%20%7Bname%3A%20%27Time%27%2C%20wave%3A%20%27.x....3.x........4.x......%27%2C%20data%3A%20%5B%27T%28x%29%27%2C%27T%28x%2B1%29%27%5D%2C%20phase%3A%200.5%20%7D%2C%0A%20%20%7B%7D%2C%0A%20%20%7Bname%3A%20%27Display%27%2C%20wave%3A%20%27x.......3.x........4.x...%27%2C%20data%3A%20%5B%27D%28x%29%27%2C%27D%28x%2B1%29%27%20%5D%7D%0A%5D%2C%0A%20%20head%3A%7B%0A%20%20%20text%3A%27GPS%20data%20delays%20to%20update%20display%27%7D%0A%7D%0A"
			
			
			
			loading="lazy"
			alt="Initial setup with long delay">
	</a>
	
	<figcaption>Initial setup with long delay</figcaption>
	
</figure></p>
<p>After the 1 PPS signal rises, we see the initial delay to the point when the GPS receiver begins to produce the Serial Messages describing the GPS receivers locations in time and space. This delay changes frequently based on the signal that is received, and is documented on the <a class="link" href="https://content.u-blox.com/sites/default/files/products/documents/u-blox8-M8_ReceiverDescrProtSpec_UBX-13003221.pdf"  target="_blank" rel="noopener"
    >ublox website</a> which shows the delay as the GPS Position fix calculation.</p>
<p><figure 
	>
	<a href="/img/countdown_gps_delays.png" >
		<img src="/img/countdown_gps_delays.png"
			
			
			
			loading="lazy"
			alt="GPS Datasheet with timepulse to serial Processing delay">
	</a>
	
	<figcaption>GPS Datasheet with timepulse to serial Processing delay</figcaption>
	
</figure></p>
<p>For our purpose on top of the GPS Position fix calculation, there is also a delay in waiting for the GPS message <code>$GNRMC</code> that we are using to extract the time data, then process that text string. This means that we only have to wait until the message we are intreseted in to arrive, at a relitivly slow baud rate of 9600. We can then process the data and not worry about the full range of other messages that we are receiving from the ublox receiver configured with its default settings, with is shown in the wavedrom diagram as &lsquo;T(x)&rsquo;, and continues after we decode our message.</p>
<p>The update of the display then follows once we have converted the current time into a number of seconds to the next 25th december for this year. For this I used a crude estimate that is based on the number of days in each month, and that we only want to know how many seconds to the next christmas once the new year has started. This falls apart as we aren&rsquo;t calculating leap years, so may produce some wired behavior I&rsquo;ve not checked.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">//find the number of commas
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">for</span><span class="p">(</span> <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">char_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">comma</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">comma</span> <span class="o">==</span> <span class="mi">9</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">date_start</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">day</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="n">date_start</span><span class="p">]</span><span class="o">-</span><span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="n">date_start</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="sc">&#39;0&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">month</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="n">date_start</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="n">date_start</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="sc">&#39;0&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">year</span> <span class="o">=</span>  <span class="mi">10</span><span class="o">*</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="n">date_start</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span><span class="o">-</span><span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="n">date_start</span><span class="o">+</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="sc">&#39;0&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">printf</span><span class="p">(</span><span class="s">&#34;UTC Date is: %02i/%02i/%02i</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">year</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">year</span><span class="p">)</span><span class="o">&amp;&amp;</span>  <span class="p">(</span><span class="n">year</span> <span class="o">&lt;</span><span class="mi">100</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">((</span><span class="n">month</span> <span class="o">&lt;=</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">day</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//calculate seconds to 25th december
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">int</span> <span class="n">days_per_month</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">31</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">31</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">day_so_far</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">count</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">count</span><span class="o">&lt;</span> <span class="p">(</span><span class="n">month</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="n">count</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">day_so_far</span> <span class="o">=</span> <span class="n">day_so_far</span> <span class="o">+</span> <span class="o">+</span><span class="n">days_per_month</span><span class="p">[</span><span class="n">count</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> 
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">end_of_year</span> <span class="o">=</span> <span class="p">(</span><span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">365</span><span class="o">-</span><span class="mi">7</span><span class="o">-</span><span class="n">day_so_far</span><span class="o">-</span><span class="n">day</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">end_of_day</span> <span class="o">=</span> <span class="p">(</span><span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span><span class="o">-</span><span class="p">((</span><span class="n">hours</span><span class="o">*</span><span class="mi">60</span> <span class="o">+</span> <span class="n">mins</span><span class="p">)</span><span class="o">*</span><span class="mi">60</span> <span class="o">+</span><span class="n">secs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">seconds_remaining</span> <span class="o">=</span> <span class="n">end_of_year</span><span class="o">+</span><span class="n">end_of_day</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// between christmas and new year
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">seconds_remaining</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// the case of not being a valid year
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">seconds_remaining</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">Display1A</span><span class="p">.</span><span class="n">setValue</span><span class="p">(</span><span class="kt">double</span><span class="p">(</span><span class="n">seconds_remaining</span><span class="p">),</span><span class="mi">0</span><span class="p">);</span>
</span></span></code></pre></div><p>I use the two digit year number as a sanity check to ensure that the date the receiver is producing is a valid number, but that is the only check that is carried out on the data, with it producing a zero output for all values that the number is not valid. This is the same behaviour as between christmas and the new year, which doesn&rsquo;t help the user understand what is going on, but is a clear way of showing that it doesn&rsquo;t currently know the actual number of seconds until christmas rather than displaying the wrong number of seconds.</p>
<p>The setup here means that until all the code is executed only at the final line does the current time finally reach the display, which will be other 100ms. The aim is to reduce this time, so I wanted to look at reducing the time from the rising edge of the 1 PPS to that update. Now the fact that I know the time in seconds will increase by a single second at the next rising edge, and use this as a way of updating the display at the rising edge.</p>
<p>For this to work I use two varribles <code>current_pps</code> and <code>last_pps</code>, the current PPS is read from the GPIO pin. This means when the <code>current_pps</code> is high and the <code>last_pps</code> is low we know there has been a rising edge at the start of the 1 PPS signal.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">current_pps</span> <span class="o">=</span> <span class="n">gpio_get</span><span class="p">(</span><span class="n">PPS1_PIN</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">current_pps</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">last_pps</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">seconds_remaining</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">Display1A</span><span class="p">.</span><span class="n">setValue</span><span class="p">(</span><span class="kt">double</span><span class="p">(</span><span class="n">seconds_remaining</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Display1A</span><span class="p">.</span><span class="n">setValue</span><span class="p">(</span><span class="kt">double</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">last_pps</span> <span class="o">=</span> <span class="n">current_pps</span><span class="p">;</span>
</span></span></code></pre></div><p>For updating the display we can use the pervious number seconds remaining as read from the GPS receiver, but the value from the pervious second, so to get the value for the current second at the PPS I take 1 from seconds remaining that was read when the GPS value was read.  As long as the <code>seconds_remaining</code> is greater than zero, we know that the number of seconds, and can update the display using <code>Display1A.setValue(double(seconds_remaining-1),0);</code> just as that happens. This using the pervious GPS message and calculating the number of seconds remaining should give a much faster reaction time to the 1PPs rising edge. the flow of signals is shown in the <a class="link" href="https://wavedrom.com/"  target="_blank" rel="noopener"
    >Wavedrom</a> <a class="link" href="https://wavedrom.com/editor.html?%7Bsignal%3A%20%5B%0A%20%20%7Bname%3A%20%27GPS%201pps%27%2C%20wave%3A%20%27l..hl.........hl.........%27%7D%2C%0A%20%20%7Bname%3A%20%27GPS%20Tx%27%2C%20wave%3A%20%27x...3..x.......4..x......%27%2C%20data%3A%20%5B%27GPS%28x%29%27%2C%20%27GPS%28x%2B1%29%27%5D%7D%2C%0A%20%20%7B%7D%2C%0A%20%20%7Bname%3A%20%27Time%27%2C%20wave%3A%20%27.x....3.x........4.x......%27%2C%20data%3A%20%5B%27T%28x%29%27%2C%27T%28x%2B1%29%27%5D%2C%20phase%3A%200.5%20%7D%2C%0A%20%20%7B%7D%2C%0A%20%20%7Bname%3A%20%27Display%27%2C%20wave%3A%20%27x..5.x........3.x........%27%2C%20data%3A%20%5B%27D%28x-1%29%27%2C%27D%28x%29%27%20%5D%7D%0A%5D%2C%0A%20%20head%3A%7B%0A%20%20%20text%3A%27Using%20value%20reported%20at%20pervious%20GPS%20data%20point%20at%20next%201PPS%20rising%20edge%27%7D%0A%7D%0A"  target="_blank" rel="noopener"
    >Signal diagram</a>.</p>
<p><figure 
	>
	<a href="https://svg.wavedrom.com/%7Bsignal%3A%20%5B%0A%20%20%7Bname%3A%20%27GPS%201pps%27%2C%20wave%3A%20%27l..hl.........hl.........%27%7D%2C%0A%20%20%7Bname%3A%20%27GPS%20Tx%27%2C%20wave%3A%20%27x...3..x.......4..x......%27%2C%20data%3A%20%5B%27GPS%28x%29%27%2C%20%27GPS%28x%2B1%29%27%5D%7D%2C%0A%20%20%7B%7D%2C%0A%20%20%7Bname%3A%20%27Time%27%2C%20wave%3A%20%27.x....3.x........4.x......%27%2C%20data%3A%20%5B%27T%28x%29%27%2C%27T%28x%2B1%29%27%5D%2C%20phase%3A%200.5%20%7D%2C%0A%20%20%7B%7D%2C%0A%20%20%7Bname%3A%20%27Display%27%2C%20wave%3A%20%27x..5.x........3.x........%27%2C%20data%3A%20%5B%27D%28x-1%29%27%2C%27D%28x%29%27%20%5D%7D%0A%5D%2C%0A%20%20head%3A%7B%0A%20%20%20text%3A%27Using%20value%20reported%20at%20pervious%20GPS%20data%20point%20at%20next%201PPS%20rising%20edge%27%7D%0A%7D%0A" >
		<img src="https://svg.wavedrom.com/%7Bsignal%3A%20%5B%0A%20%20%7Bname%3A%20%27GPS%201pps%27%2C%20wave%3A%20%27l..hl.........hl.........%27%7D%2C%0A%20%20%7Bname%3A%20%27GPS%20Tx%27%2C%20wave%3A%20%27x...3..x.......4..x......%27%2C%20data%3A%20%5B%27GPS%28x%29%27%2C%20%27GPS%28x%2B1%29%27%5D%7D%2C%0A%20%20%7B%7D%2C%0A%20%20%7Bname%3A%20%27Time%27%2C%20wave%3A%20%27.x....3.x........4.x......%27%2C%20data%3A%20%5B%27T%28x%29%27%2C%27T%28x%2B1%29%27%5D%2C%20phase%3A%200.5%20%7D%2C%0A%20%20%7B%7D%2C%0A%20%20%7Bname%3A%20%27Display%27%2C%20wave%3A%20%27x..5.x........3.x........%27%2C%20data%3A%20%5B%27D%28x-1%29%27%2C%27D%28x%29%27%20%5D%7D%0A%5D%2C%0A%20%20head%3A%7B%0A%20%20%20text%3A%27Using%20value%20reported%20at%20pervious%20GPS%20data%20point%20at%20next%201PPS%20rising%20edge%27%7D%0A%7D%0A"
			
			
			
			loading="lazy"
			alt="After updating to write value on 1PPS Rising edge">
	</a>
	
	<figcaption>After updating to write value on 1PPS Rising edge</figcaption>
	
</figure></p>
<p>With this new setup we can now see the updated time imediatly after the rising edge on th 1 PPS, this now means that the delay time has been reduced by predicting the current time based on pervious gps data point and the Time Pulse signal.</p>
<p><figure 
	>
	<a href="/img/countdown_gps_update_time.png" >
		<img src="/img/countdown_gps_update_time.png"
			
			
			
			loading="lazy"
			alt="Much sorter update time to get the time to the display">
	</a>
	
	<figcaption>Much sorter update time to get the time to the display</figcaption>
	
</figure></p>
<p>The improvement can be measured by taking a close look at the signal using the Pulse View. Which we can compared to the pervious measurment made at the start of this post.</p>
<p><figure 
	>
	<a href="/img/countdown_gps_after_time.png" >
		<img src="/img/countdown_gps_after_time.png"
			
			
			
			loading="lazy"
			alt="Sigrok time remaining after change">
	</a>
	
	<figcaption>Sigrok time remaining after change</figcaption>
	
</figure></p>
<p>Now that the countdown timer is up and running, it just requires the 3D printed case modifying to allow space for the <a class="link" href="https://jjhorton.co.uk/posts/gps_pmod_board/" >PMod GPS module</a>. With that done the countdown clock will be ready to count down to christmas both this yeaar and next, without the need for any external hardware to provide the current time. This makes it much more flexible and useful, i&rsquo;m also planning on using the GPS module for a few other projeccts that I have lined up.</p>
<p><figure 
	>
	<a href="/img/countdown_gps_running.png" >
		<img src="/img/countdown_gps_running.png"
			
			
			
			loading="lazy"
			alt="Completed GPS Countdown clock up and running">
	</a>
	
	<figcaption>Completed GPS Countdown clock up and running</figcaption>
	
</figure></p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/rp2040/">RP2040</a>
        
            <a href="/tags/gps/">GPS</a>
        
            <a href="/tags/pmod/">PMod</a>
        
            <a href="/tags/raspberry-pi/">Raspberry Pi</a>
        
    </section>


    </footer>


    
</article>

    

    <aside class="related-contents--wrapper">
    
    
        <h2 class="section-title">Related contents</h2>
        <div class="related-contents">
            <div class="flex article-list--tile">
                
                    
<article class="has-image">
    <a href="/posts/gps_pmod_board/">
        
        
            <div class="article-image">
                
                    <img src="/img/Pmod-GPS_Purple.jpg" loading="lazy" data-key="" data-hash="/img/Pmod-GPS_Purple.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Creating a GPS PMod Board</h2>
        </div>
    </a>
</article>
                
                    
<article class="has-image">
    <a href="/posts/rp2040_mini_pmod/">
        
        
            <div class="article-image">
                
                    <img src="/img/RP2040_mini_complete.jpg" loading="lazy" data-key="" data-hash="/img/RP2040_mini_complete.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">RP2040 Mini PMod</h2>
        </div>
    </a>
</article>
                
                    
<article class="has-image">
    <a href="/posts/rp2040_pmod/">
        
        
            <div class="article-image">
                
                    <img src="/img/rp2040pmod_blankpcb.jpg" loading="lazy" data-key="" data-hash="/img/rp2040pmod_blankpcb.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">RP2040 PMod PCB</h2>
        </div>
    </a>
</article>
                
                    
<article class="has-image">
    <a href="/posts/kicad-github-panels/">
        
        
            <div class="article-image">
                
                    <img src="/img/RP2040_PCB_Panels.jpg" loading="lazy" data-key="" data-hash="/img/RP2040_PCB_Panels.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Automatically panellization of Kicad PCB&#39;s with github Actions</h2>
        </div>
    </a>
</article>
                
                    
<article class="has-image">
    <a href="/posts/ir_hub75/">
        
        
            <div class="article-image">
                
                    <img src="/img/hub75_header.jpg" loading="lazy" data-key="" data-hash="/img/hub75_header.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Infrared Sensor with an LED Matrix</h2>
        </div>
    </a>
</article>
                
            </div>
        </div>
    
</aside>

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2006 - 
        
        2023 James Horton
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.6.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer="true"
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer="true"
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css"integrity="sha256-c0uckgykQ9v5k&#43;IqViZOZKc47Jn7KQil4/MP3ySA3F8="crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css"integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE="crossorigin="anonymous"
            >

            </main>
    

        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js"integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g="crossorigin="anonymous"
                defer="false"
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
