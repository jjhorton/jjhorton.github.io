<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>JJ Horton - FPGA</title>
        <link rel="stylesheet" href="https://www.jjhorton.co.uk/theme/css/main.css" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
<a href="http://github.com/jjhorton/">
<img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub" />
</a>
        <header id="banner" class="body">
                <h1><a href="https://www.jjhorton.co.uk/">JJ Horton </a></h1>
                <nav><ul>
                    <li><a href="/pages/about.html">About</a></li>
                    <li><a href="/archives.html">Posts</a></li>
                    <li><a href="http://linkedin.com/in/jjhorton">CV</a></li>
                </ul>
                </nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="https://www.jjhorton.co.uk/pmod-8x8-infrared-sensor.html">PMod 8x8 Infrared Sensor</a></h1>
<footer class="post-info">
        <span>Mon 12 July 2021</span>
<span>| tags: <a href="https://www.jjhorton.co.uk/tag/pmod.html">PMod</a><a href="https://www.jjhorton.co.uk/tag/fpga.html">FPGA</a><a href="https://www.jjhorton.co.uk/tag/pico.html">Pico</a></span>
</footer><!-- /.post-info --><p>After seeing a post on twitter where someone was experimenting with the AMG8834 sensor, and I wanted to give it a go. This sensor can be purchased preassembled on <a href="https://www.aliexpress.com/wholesale?&amp;SearchText=amg8833">breakout boards</a>, ready to drop into a breadboard and build a system around.</p>
<p>While I could build something around these breakout boards, I decided to take a different route and have a go at building one of my own boards. for the connector I wanted to use a PMod, as this would allow me to use the board with both my <a href="https://www.raspberrypi.org/products/raspberry-pi-pico/">Raspberry Pi Pico</a> <a href="https://www.jjhorton.co.uk/pico-pmod-breakout-pcb.html">Boards</a> that I just made, as well as the <a href="https://www.crowdsupply.com/1bitsquared/icebreaker-fpga">iceBreaker</a> FPGA board I already own, and maybe in the future I may have a go with getting it working with my <a href="https://store.digilentinc.com/cora-z7-zynq-7000-single-core-and-dual-core-options-for-arm-fpga-soc-development/">Zynq based Cora Z7 board</a>. This makes the PMod connector an excellent solution for my small prototypes, to be able to move between these types of boards.</p>
<p><img src="images/PModInfrared_schematic.png" width="500"><div></p>
<p>For building my breakout board, I use KiCAD, and the process of building this board is as simple as copying the design as given in the sensors datasheet, the circuit required is very simple and helps minimise any potential errors. the main effort was ensuring that the i2c interface pins match up with the available i2c pins on the <a href="https://www.jjhorton.co.uk/pico-pmod-breakout-pcb.html">Raspberry Pi Pico PMod board</a>  connector. Once that is done its just a case of order the PCB and waiting for it to turn up in the post.</p>
<p><img src="images/PModinfrerred_pcb.png" width="500"><div></p>
<p>The sensor output is an 8x8 array of values, which refresh at a maximum rate of 10Hz, so my initial solution to test this sensor out is to stream it over the Raspberry Pi's serial interface Back to my Computer where I will plot the result.</p>
<p>To get started I took some of the code from the Raspberry Pico C/C++ examples, and used that to work out how to get the pins setup to work with i2c on the pins that I needed. I really like using the PIO, as it gives you a lot of flexibility, although it is taking a bit of getting used to.</p>
<div class="highlight"><pre><span></span>stdio_init_all();
// This example will use I2C1 on the SDA and SCL pins (2, 3 on a Pico)
i2c_init(i2c1, 1000000);

//Setup the I2C pins
gpio_set_function(2, GPIO_FUNC_I2C);
gpio_set_function(3, GPIO_FUNC_I2C);
gpio_pull_up(2);
gpio_pull_up(3);

// Make the I2C pins available to picotool
bi_decl(bi_2pins_with_func(2, 3, GPIO_FUNC_I2C));
</pre></div>

<p>The reading of the pixel values turned out to be more simple than I was expecting, with the addr of the sensor being set with the hardware configuration <code>int addr = 0b01101000;</code>. For getting the values, we just write position of the first value, and then just keep reading the two bytes, which contain the 14 bit values for the pixel, 64 times. Each time we have read a value, we convert it to a floating point value and scale it using the value 0.25, which was given in the datasheet for the sensor.  </p>
<div class="highlight"><pre><span></span>//read the pixel values
val = 0x80;
i2c_write_blocking(i2c1, addr, &amp;val, 1, true);

for(int i = 0; i&lt;63;++i){
    ret = i2c_read_blocking(i2c1, addr, &amp;rxdata[0], 2, true);
    if(i%8 == 0){
        printf(&quot;\n&quot;);
    }
    float result  = (int16_t)((((uint16_t)rxdata[1] &lt;&lt; 8) | ((uint16_t)rxdata[0]))&lt;&lt; 4) &gt;&gt; 4;
    printf(&quot;%6.2f, &quot;, 0.25*result);
}
</pre></div>

<p>The printf function is then just printing to the serial interface, where we will be picking them up on the PC that is connected to it.</p>
<p>For plotting the values from the Pico we are using a simple python script running on a PC, for that we have a number of dependancies, which we will first import.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">interpolate</span>
<span class="kn">import</span> <span class="nn">serial</span>
</pre></div>

<p>We then need to setup the serial link, so that we can receive the output from the Raspberry Pi Pico on my MacBook, at this point we also initialise the <code>my_results</code> array where we will be storing the values, along with a counter.</p>
<div class="highlight"><pre><span></span>ser = serial.Serial(&#39;/dev/tty.usbmodem1101&#39;, 115200 ,timeout=1)
my_result = np.zeros([8,8],dtype=np.float32)
my_counter = 0
</pre></div>

<p>Next up we need to setup the figure that we will plot the results in, for this we are using matplotlib, we are going to set the colourbar range to be from 0 to 40 degrees with <code>vmin=0, vmax=40</code> , as this the range I'm expecting to see when testing it out.</p>
<div class="highlight"><pre><span></span>fg = plt.figure()
ax = fg.gca()
h = ax.imshow(my_result, vmin=0, vmax=40,cmap=plt.get_cmap(&#39;inferno&#39;))
plt.colorbar(h)
</pre></div>

<p>Now we are ready to enter our main program loop, so that this runs indefinitely i'm using a <code>while(1)</code> statement to keep it looping round. This is then followed by the <code>ser.readline()</code> command, which should hopefully get us an string containing 8 comma seperated values from the Raspberry Pi Pico. To check it is likley the values we are expecting we check the length, if its long enough to be our values, we seperate the values using <code>split(",")</code> function, and convert the values to be a <code>np.float32</code> datatype.   </p>
<div class="highlight"><pre><span></span><span class="nf">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="s s-Atom">:</span>
    <span class="s s-Atom">my_data</span> <span class="o">=</span> <span class="s s-Atom">ser</span><span class="p">.</span><span class="nf">readline</span><span class="p">()</span>

  <span class="s s-Atom">if</span> <span class="nf">len</span><span class="p">(</span><span class="s s-Atom">my_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="s s-Atom">:</span>
        <span class="s s-Atom">my_string</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="s s-Atom">my_data</span><span class="p">)[</span><span class="mi">3</span><span class="p">:-</span><span class="mi">7</span><span class="p">]</span>

        <span class="s s-Atom">my_result</span><span class="p">[</span><span class="s s-Atom">my_counter</span><span class="p">,</span><span class="mi">0</span><span class="s s-Atom">:</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="s s-Atom">np</span><span class="p">.</span><span class="nf">asarray</span><span class="p">(</span><span class="s s-Atom">my_string</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">),</span><span class="s s-Atom">dtype</span><span class="o">=</span><span class="s s-Atom">np</span><span class="p">.</span><span class="s s-Atom">float32</span><span class="p">)</span>
        <span class="s s-Atom">my_counter</span> <span class="o">=</span> <span class="s s-Atom">my_counter</span> <span class="o">+</span> <span class="mi">1</span>
</pre></div>

<p>Now we have a line of numbers, once we have 8 of them we now have all the image. This mean we need to update the plot that we created earlier with the values received from the sensor, before reseting our counter back to zero.</p>
<div class="highlight"><pre><span></span>    if my_counter &gt; 7:
        h.set_data(np.fliplr(np.flip(my_result)))
        plt.draw(), plt.pause(1e-4)
</pre></div>

<p><img src="images/PModinfrerred_running.png" width="500"><div></p>
<p>This then allows us to see what the sensor is seeing, which I was really happy with when I checked out that my solution actually worked the morning after writing the code.</p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">A quick test this morning to confirm I did get my AMG8834 thermal sensor working with the Pico, although given the time the files were last edited last night I might need that energy drink soon <a href="https://twitter.com/hashtag/electronics?src=hash&amp;ref_src=twsrc%5Etfw">#electronics</a> <a href="https://twitter.com/hashtag/rppico?src=hash&amp;ref_src=twsrc%5Etfw">#rppico</a> <a href="https://twitter.com/hashtag/rp2040?src=hash&amp;ref_src=twsrc%5Etfw">#rp2040</a> <a href="https://twitter.com/hashtag/LateNight?src=hash&amp;ref_src=twsrc%5Etfw">#LateNight</a> <a href="https://t.co/bSTmoAp1lP">pic.twitter.com/bSTmoAp1lP</a></p>&mdash; James Horton (@JamesjHorton) <a href="https://twitter.com/JamesjHorton/status/1403252809064198147?ref_src=twsrc%5Etfw">June 11, 2021</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>With that now completed, my next task is to look at getting an identical example in HDL which uses either the Icebreaker Board or the Colorlite i5, this will be a bit more of a challenge, but it will be a great little project for improving my HDL coding skills.</p>                </article>
            </aside><!-- /#featured -->
                <section id="content" class="body">
                    <h1>Other articles</h1>
                    <ol id="posts-list" class="hfeed">

            <li><article class="hentry">
                <header>
                    <h1><a href="https://www.jjhorton.co.uk/pico-pmod-breakout-pcb.html" rel="bookmark"
                           title="Permalink to Pico PMod breakout PCB">Pico PMod breakout PCB</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <span>Mon 31 May 2021</span>
<span>| tags: <a href="https://www.jjhorton.co.uk/tag/raspberry-pi.html">Raspberry Pi</a><a href="https://www.jjhorton.co.uk/tag/pico.html">Pico</a><a href="https://www.jjhorton.co.uk/tag/pmod.html">PMod</a><a href="https://www.jjhorton.co.uk/tag/fpga.html">FPGA</a></span>
</footer><!-- /.post-info -->                <p>Building a PMod Based board to the New Raspberry Pi Pico</p>
                <a class="readmore" href="https://www.jjhorton.co.uk/pico-pmod-breakout-pcb.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="https://www.jjhorton.co.uk/continuous-integration-for-firmware-with-github-actions.html" rel="bookmark"
                           title="Permalink to Continuous Integration for Firmware with Github Actions">Continuous Integration for Firmware with Github Actions</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <span>Wed 17 March 2021</span>
<span>| tags: <a href="https://www.jjhorton.co.uk/tag/github.html">Github</a><a href="https://www.jjhorton.co.uk/tag/ci.html">CI</a><a href="https://www.jjhorton.co.uk/tag/fpga.html">FPGA</a></span>
</footer><!-- /.post-info -->                <p>Using Github actions to simulate, test and build an FPGA design</p>
                <a class="readmore" href="https://www.jjhorton.co.uk/continuous-integration-for-firmware-with-github-actions.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>
            </ol><!-- /#posts-list -->
<p class="paginator">
    Page 1 / 1
</p>
            </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="http://github.com/jjhorton">Github</a></li>
                            <li><a href="http://twitter.com/jamesjhorton">Twitter</a></li>
                            <li><a href="http://linkedin.com/in/jjhorton">LinkedIn</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <p>Powered by <a href="http://getpelican.com/">Pelican</a>. Theme <a href="https://github.com/blueicefield/pelican-blueidea/">blueidea</a>, inspired by the default theme.</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-59185025-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
</body>
</html>