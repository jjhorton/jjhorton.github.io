<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>JJ Horton - James</title>
        <link rel="stylesheet" href="http://jjhorton.co.uk/theme/css/main.css" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
<a href="http://github.com/jjhorton/">
<img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub" />
</a>
        <header id="banner" class="body">
                <h1><a href="http://jjhorton.co.uk/">JJ Horton </a></h1>
                <nav><ul>
                    <li><a href="/pages/about.html">About</a></li>
                    <li><a href="/archives.html">Posts</a></li>
                    <li><a href="http://linkedin.com/in/jjhorton">CV</a></li>
                </ul>
                </nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="http://jjhorton.co.uk/continuous-integration-for-firmware-with-github-actions.html">Continuous Integration for Firmware with Github Actions</a></h1>
<footer class="post-info">
        <span>Wed 17 March 2021</span>
<span>| tags: <a href="http://jjhorton.co.uk/tag/github.html">Github</a><a href="http://jjhorton.co.uk/tag/ci.html">CI</a><a href="http://jjhorton.co.uk/tag/fpga.html">FPGA</a></span>
</footer><!-- /.post-info --><p>For a couple of months I've been slowly building up a little project using some Development boards that include an FPGA, typically once i've finished editing my design I run all my simulations, tests and then check I can still build the firmware. While running these manually before each commit isn't typically much an issue, I wanted to automate this.</p>
<p>The project i'm working on uses a <a href="https://www.aliexpress.com/item/1005001686186007.html">ColorLite i5 FPGA board</a>, this with it Lattice ECP5 FPGA allows me to use a set of Open source tools to test and build my FPGA images. For simulations I'm using <a href="https://www.veripool.org/wiki/verilator">Verilator</a>, while for creating the FPGA images I'm using a combination of <a href="https://github.com/YosysHQ/yosys">Yosys</a> and <a href="https://github.com/YosysHQ/nextpnr">Next-PNR</a>. These excellent tools allow me to make use of the GitHub actions to test my FPGA images with very minimal effort.</p>
<p>While my simulations require a couple of commands so these are contained to a makefile, the commands to build the FPGA image are very simple.</p>
<div class="highlight"><pre><span></span>yosys -p <span class="s1">&#39;synth_ecp5 -json top.json&#39;</span> -S firmware/top.v
nextpnr-ecp5 --25k --package CABGA381 --json top.json --lpf firmware/colorlight.lpf --textcfg out.config
</pre></div>

<p>To build the FPGA image is a simple task of running my 'top.v' verilog file though yosys, before doing place and route with nextpnr, which again is a single line. These simple lines allow me to test if I can build my design, as long as they don't return any error, then the build is successful.</p>
<p>The GitHub actions are based on YAML files, which contain details of the container that the image is being run on, and the commands that are run for that image. These files are stored in the folder <code>.github/workflow</code> in the GitHub repository, I have two, one which runs the Simulation and one which build the FPGA Image.</p>
<p>We will talk though the build firmware Github Action, which I have called <code>Build Firmware</code>. I have decided that this should be run whenever I push the repositry, for Pull requests and on demand. So we define the name of the action, and add the description of when it should be run, the <code>workflow_dispatch</code> allows me to manually trigger it being run.</p>
<div class="highlight"><pre><span></span><span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Build Firmware</span>

<span class="nt">on</span><span class="p">:</span>
  <span class="nt">push</span><span class="p">:</span>
  <span class="nt">pull_request</span><span class="p">:</span>
  <span class="nt">workflow_dispatch</span><span class="p">:</span>
</pre></div>

<p>With the name, and when the action should be run defined, we move onto defining the action. For my build we need to define the <code>job</code> and the <code>build</code>. For this I am running on Ubuntu Latest as my image.</p>
<div class="highlight"><pre><span></span><span class="nt">jobs</span><span class="p">:</span>
  <span class="nt">build</span><span class="p">:</span>
    <span class="nt">runs-on</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
</pre></div>

<p>Now that we have the image we are running on we need to add the dependancies that are required for building out FPGA image. First step is to checkout our repository we are running from with the
<code>uses: actions/checkout@v2</code>, which will get our repo using the default settings without any issues. With both Yosys and Next-Pnr needed to build the image, the next step is a little different to what I originally had planned. I thought that I would need to build these tools from source like I would on my own computer, but that is very time consuming, and I came across some pip packages, which installs them much quicker. This reduces build time, which on private repo's on GitHub are billed after you are passed your allowance.</p>
<div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">actions/checkout@v2</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Install the required Tools</span>
<span class="nt">run</span><span class="p">:</span> <span class="p p-Indicator">|</span>
    <span class="no">sudo -H pip3 install yowasp-yosys</span>
    <span class="no">sudo -H pip3 install yowasp-nextpnr-ecp5-25k</span>
</pre></div>

<p>One problem I did come across when installing these packages, was that if I ran these <code>pip3 install</code> commands without sudo, then the commands that I need then aren't available. Running with <code>sudo</code> solves this issue although i'm not sure why.  </p>
<p>Now we have all the tools in place we can now run both yosys and nextpnr, using the commands specific to the <code>yowasp-yosys</code> and <code>yowasp-nextpnr</code> packages, which are a little different to the standard commands I would use on my own Laptop.  </p>
<div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Run yosys on the files</span>
    <span class="l l-Scalar l-Scalar-Plain">run</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yowasp-yosys -p &#39;synth_ecp5 -json top.json&#39; -S firmware/top.v</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Run Place and Route</span>
    <span class="l l-Scalar l-Scalar-Plain">run</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yowasp-nextpnr-ecp5 --25k --package CABGA381 --json top.json --lpf firmware/colorlight.lpf --textcfg out.config</span>
</pre></div>

<p>We can then pull all those components into a single <code>FirmwareBuild.yaml</code> file in the <code>.github/workflow</code> folder, which is then run on each push to the repo. The current design is very simple, but runs in a little over 30 seconds for the build, this makes running on each push manageable, but as the firmware design continues to grow, I may look to only run on Pull request.  </p>
<div class="highlight"><pre><span></span><span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Build Firmware</span>

<span class="nt">on</span><span class="p">:</span>
  <span class="nt">push</span><span class="p">:</span>
  <span class="nt">pull_request</span><span class="p">:</span>
  <span class="nt">workflow_dispatch</span><span class="p">:</span>

<span class="nt">jobs</span><span class="p">:</span>
  <span class="nt">build</span><span class="p">:</span>
    <span class="nt">runs-on</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
    <span class="nt">steps</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">actions/checkout@v2</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Install the required Tools</span>
        <span class="nt">run</span><span class="p">:</span> <span class="p p-Indicator">|</span>
          <span class="no">sudo -H pip3 install yowasp-yosys</span>
          <span class="no">sudo -H pip3 install yowasp-nextpnr-ecp5-25k</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Run yosys on the files</span>
        <span class="nt">run</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yowasp-yosys -p &#39;synth_ecp5 -json top.json&#39; -S firmware/top.v</span>

      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Run Place and Route</span>
        <span class="nt">run</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yowasp-nextpnr-ecp5 --25k --package CABGA381 --json top.json --lpf firmware/colorlight.lpf --textcfg out.config</span>
</pre></div>

<p>The GitHub action for running the simulation is very similar, but instead of <code>pip3 install</code> for the build tools, I require <code>Verilator</code> which is available to install using apt. As the code to run my Verilator tests is identical between how i run it on my computer and in the GitHub action, I just us my make command to run the tests.</p>
<div class="highlight"><pre><span></span><span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Simulate Firmware</span>

<span class="nt">on</span><span class="p">:</span>
  <span class="nt">push</span><span class="p">:</span>
  <span class="nt">pull_request</span><span class="p">:</span>
  <span class="nt">workflow_dispatch</span><span class="p">:</span>

<span class="nt">jobs</span><span class="p">:</span>
  <span class="nt">test</span><span class="p">:</span>
    <span class="nt">runs-on</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>

    <span class="nt">steps</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">actions/checkout@v2</span>

      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Install Verilator required for the simulation</span>
        <span class="nt">run</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sudo apt install verilator</span>

      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Run the Serial Test</span>
        <span class="nt">run</span><span class="p">:</span> <span class="p p-Indicator">|</span>
          <span class="no">export VINC=/usr/share/verilator/include</span>
          <span class="no">make test-serial</span>
</pre></div>

<p>My next step for the these GitHub Actions, is to look at extracting some statistics from particularly the build process. I'm  interested in monitoring the FPGA utilisation and frequency that the design can be run at, being able to see the effect of each pull request would be advantageous for keeping an eye on how well my design is coming together and the effect of different changes.</p>                </article>
            </aside><!-- /#featured -->
                <section id="content" class="body">
                    <h1>Other articles</h1>
                    <ol id="posts-list" class="hfeed">

            <li><article class="hentry">
                <header>
                    <h1><a href="http://jjhorton.co.uk/nvidia-jetson-nano-2gb-testing.html" rel="bookmark"
                           title="Permalink to Nvidia Jetson Nano 2Gb Testing">Nvidia Jetson Nano 2Gb Testing</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <span>Mon 22 February 2021</span>
<span>| tags: <a href="http://jjhorton.co.uk/tag/jetson.html">Jetson</a><a href="http://jjhorton.co.uk/tag/testing.html">Testing</a></span>
</footer><!-- /.post-info -->                <p>Testing out the Nvidia Jetson Nano 2Gb Board with a simple calculating Pi Testing</p>
                <a class="readmore" href="http://jjhorton.co.uk/nvidia-jetson-nano-2gb-testing.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="http://jjhorton.co.uk/nvidia-jetson-case.html" rel="bookmark"
                           title="Permalink to Nvidia Jetson case">Nvidia Jetson case</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <span>Sun 31 January 2021</span>
<span>| tags: <a href="http://jjhorton.co.uk/tag/jetson.html">Jetson</a><a href="http://jjhorton.co.uk/tag/3dprinting.html">3DPrinting</a></span>
</footer><!-- /.post-info -->                <p>Building a mini rack mount case for my Nvidia Jetson 2GB</p>
                <a class="readmore" href="http://jjhorton.co.uk/nvidia-jetson-case.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="http://jjhorton.co.uk/bring-a-raspberry-pi-cluster-back-to-life.html" rel="bookmark"
                           title="Permalink to Bring a Raspberry Pi Cluster Back to Life">Bring a Raspberry Pi Cluster Back to Life</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <span>Sun 31 May 2020</span>
<span>| tags: <a href="http://jjhorton.co.uk/tag/raspberrypi.html">RaspberryPi</a><a href="http://jjhorton.co.uk/tag/pi2.html">Pi2</a><a href="http://jjhorton.co.uk/tag/cluster.html">Cluster</a><a href="http://jjhorton.co.uk/tag/3dprinting.html">3DPrinting</a></span>
</footer><!-- /.post-info -->                <p>Bring back an old Raspberry Pi cluster back to life for some new projects</p>
                <a class="readmore" href="http://jjhorton.co.uk/bring-a-raspberry-pi-cluster-back-to-life.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="http://jjhorton.co.uk/new-website.html" rel="bookmark"
                           title="Permalink to New Website">New Website</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <span>Mon 08 May 2017</span>
<span>| tags: <a href="http://jjhorton.co.uk/tag/pelican.html">pelican</a><a href="http://jjhorton.co.uk/tag/website.html">website</a><a href="http://jjhorton.co.uk/tag/github.html">github</a><a href="http://jjhorton.co.uk/tag/pages.html">pages</a></span>
</footer><!-- /.post-info -->                <p>Final starting to get my website up and running again, now hosted on github pages and using pelican</p>
                <a class="readmore" href="http://jjhorton.co.uk/new-website.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>
            </ol><!-- /#posts-list -->
<p class="paginator">
    Page 1 / 4
        <a href="http://jjhorton.co.uk/author/james2.html">&raquo;</a>
        <a href="http://jjhorton.co.uk/author/james4.html">&#8649;</a>
</p>
            </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="http://github.com/jjhorton">Github</a></li>
                            <li><a href="http://twitter.com/jamesjhorton">Twitter</a></li>
                            <li><a href="http://linkedin.com/in/jjhorton">LinkedIn</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <p>Powered by <a href="http://getpelican.com/">Pelican</a>. Theme <a href="https://github.com/blueicefield/pelican-blueidea/">blueidea</a>, inspired by the default theme.</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-59185025-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
</body>
</html>